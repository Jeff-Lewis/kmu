<div class="container-fluid">

  <div class="row">
    <div class="col-md-12">
        <div class="panel-heading header">
          <h2>
              SPENDENINITIATIVE <%= @donation.name %>
          </h2>
        </div>
        <div class="panel-body">
          <%= link_to donations_path :page => session[:page] do %>
            <i class="btn btn-primary btn-lg glyphicon glyphicon-list"></i>
          <% end %>
          <% if user_signed_in? %>
  	        <%= link_to new_favourit_path :object_name => "Donation", :object_id => @donation.id, :user_id => current_user.id do %>
              <i class="btn btn-primary btn-lg glyphicon glyphicon-star"></i>
            <% end %>
            <% if (@donation.company_id != nil and current_user.id == @donation.company.user_id) %>
      	        <%= link_to edit_donation_path(@donation) do %>
                  <i class="btn btn-primary btn-lg glyphicon glyphicon-wrench"></i>
                <% end %>
      	        <%= link_to @donation, method: :delete, data: { confirm: 'Are you sure?' } do %>
                  <i class="btn btn-danger btn-lg pull-right glyphicon glyphicon-trash"></i>
                <% end %>
            <% end %>
  	        <%= link_to new_webmaster_path :object_name => "Donation", :object_id => @donation.id, :user_id => current_user.id do %>
              <i class="btn btn-warning btn-lg pull-right glyphicon glyphicon-eye-open"></i>
            <% end %>
          <% end %>
        </div>
        <div class="panel-body">
    			<blockquote>
  	        <%= link_to @donation.company do %>
              <i class="btn btn-primary btn-lg glyphicon glyphicon-info-sign"></i>
            <% end %>
    				<b>
    					<%= @donation.company.name %>
    				</b><br>
    				<% if @donation.company.avatar_file_name == nil %>
              <%= image_tag("company_a.png", :size => "200x200", class:"img-rounded" ) %>
            <% else %>
              <%= image_tag @donation.company.avatar(:medium), class:"img-rounded"  %>
            <% end %>
    				<b><br>
    					Beschreibung
    				</b><br>
    				<small><%= @donation.description %></small>
    				<br>
        	</blockquote>
          <cite><%= @donation.created_at.strftime("%d.%m.%Y") %></cite>        
        </div>
    </div>
  </div>
  <br>

  <div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
          <% if user_signed_in? %>
            <% if current_user.id == @donation.company.user_id %>
              <%= link_to new_donation_detail_path :mode => "private", :donation_id => @donation.id do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-plus"></i>
              <% end %>
            <% end %>
          <% end %>
            ZUSATZINFORMATIONEN
        </h2>
      </div>
      <div class="panel-body">
      		<% @donation.donation_details.each do |dd| %>
    				<a class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-375571" href="#panel-element-<%= dd.id %>"><h3><%= dd.name %></h3></a>
    				<div id="panel-element-<%= dd.id %>" class="panel-collapse collapse">
      				<% if dd.avatar_file_name == nil %>
                <%= image_tag("present.png", :size => "200x200", class:"img-rounded" ) %>
              <% else %>
                <%= image_tag dd.avatar(:medium), class:"img-rounded"  %>
              <% end %>
              <p>
  						<%= dd.description %>
  						</p>
              <% if user_signed_in? %>
                <% if current_user.id == @donation.company.user_id %>
        	        <%= link_to edit_donation_detail_path(dd) do %>
                    <i class="btn btn-primary btn-lg glyphicon glyphicon-wrench"></i>
                  <% end %>
        	        <%= link_to dd, method: :delete, data: { confirm: 'Are you sure?' } do %>
                    <i class="btn btn-danger btn-lg glyphicon glyphicon-trash"></i>
                  <% end %>
                <% end %>
              <% end %>
      			</div>
      		<% end %>
    	</div>
    </div>
  </div>
  <br>
  
  <div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
          <% if user_signed_in? %>
            <%= link_to new_donation_stat_path :donation_id => @donation.id, :dontype => "User" do %>
              <i class="btn btn-primary btn-lg glyphicon glyphicon-plus"></i>
            <% end %>
            <% if Company.where('active=? and user_id=?',true,current_user.id).count > 0 %>
              <%= link_to new_donation_stat_path :donation_id => @donation.id, :dontype => "Company" do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-plus"></i>
              <% end %>
            <% end %>
          <% end %>
            SPENDER
        </h2>
      </div>
      <div class="panel-body">
				<a class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-375572" href="#panel-spender"><h3>Spendenliste (aktueller Stand: <%= sprintf("%05.2f CHF", @donation.donation_stats.sum(:amount)) %>)</h3></a>
				<div id="panel-spender" class="panel-collapse collapse">
          <% if @donation.donation_stats.count > 0 %>
						<table class="table table striped">
						  <thead>
						    <tr>
    						  <th "colspan=3">
    						    Spender
    						  </th>
    						  <th>
    						    Betrag
    						  </th>
    						  <th>
    						    Datum
    						  </th>
                </tr>
              </thead>
              <tbody>
              <% @donation.donation_stats.order(amount: :desc).each do |ds| %>
                <tr>
                  <td>
                  <% if ds.user_id != nil %>
          	        <%= link_to ds.user do %>
                      <i class="btn btn-primary btn-lg glyphicon glyphicon-info-sign"></i>
                    <% end %>
                  <% end %>
                  <% if ds.company_id != nil %>
          	        <%= link_to ds.company do %>
                      <i class="btn btn-primary btn-lg glyphicon glyphicon-info-sign"></i>
                    <% end %>
                  <% end %>
                  <% if user_signed_in? %>
                    <% if (ds.user_id != nil and current_user.id == ds.user_id) or (ds.company_id != nil and current_user.id == ds.company.user_id) %>
            	        <%= link_to edit_donation_stat_path(ds) do %>
                        <i class="btn btn-primary btn-lg glyphicon glyphicon-wrench"></i>
                      <% end %>
            	        <%= link_to ds, method: :delete, data: { confirm: 'Are you sure?' } do %>
                        <i class="btn btn-danger btn-lg glyphicon glyphicon-trash"></i>
                      <% end %>
                    <% end %>
                  <% end %>
                  </td>
                  <td>
        				  <% if ds.company_id != nil %>
            				<% if ds.company.avatar_file_name == nil %>
                      <%= image_tag("company_a.png", :size => "200x200", class:"img-rounded" ) %>
                    <% else %>
                      <%= image_tag ds.company.avatar(:medium), class:"img-rounded"  %>
                    <% end %>
          				  <%= ds.company.name %>
          				<% end %>
          				<% if ds.user_id != nil %>
            				<% if ds.user.avatar_file_name == nil %>
                      <%= image_tag("user_a.png", :size => "200x200", class:"img-rounded" ) %>
                    <% else %>
                      <%= image_tag ds.user.avatar(:medium), class:"img-rounded"  %>
                    <% end %>
          				  <%= ds.user.name + " " + ds.user.lastname  %>
          				<% end %>
          				</td>
          				<td>
                  <% if !ds.anonymous %>
                      <%= sprintf("%05.2f CHF", ds.amount) %>
                    <% else %>
                      *****.** CHF
                  <% end %>
                  </td>
                  <td><%= ds.created_at.strftime("%d.%m.%Y")%></td>
                </tr>
              <% end %>
              </tbody>
						</table>
  				<% end %>
  			</div>
      </div>
    </div>
  </div>
  <br>

  <div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
            ORTSANGABE
        </h2>
      </div>
    </div>
    <div class="col-md-12">
      <div class="panel-body">
        <div id="map">
          <div id="map-canvas"></div>
        </div>
      </div>
    </div>
  </div>
  <br>

  <div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
            KONTAKT
        </h2>
      </div>
    </div>
    <div class="col-md-12">
      <div class="panel-body">
        <%= form_tag donation_path, :method => "get" do %>
            <div class="form-group">
              <% if @donation.company.user.phone1 == "" %>
                <i class="glyphicon glyphicon-phone"></i>
                <%= @donation.company.user.phone1 %><br>
              <% end %>
              <% if @donation.company.user.phone2 == "" %>
              <i class="glyphicon glyphicon-phone"></i>
                <%= @donation.company.user.phone2 %><br>
              <% end %>
              <i class="glyphicon glyphicon-envelope"></i>
              <%= @donation.company.user.email %><br>
            </div>
            <div class="form-group">
              <%= label_tag "Betreff" %>
              <%= text_field_tag :header, @donation.name, class:"form-control" %>
            </div>
            <div class="form-group">
              <%= label_tag "Nachricht" %>
              <%= text_area_tag :body, params[:body], rows: 5, class:"form-control" %>
            </div>
            <div class="form-group">
              <%= submit_tag "Senden", :name => nil, class:"btn btn-primary btn-lg" %>
            </div>
        <% end %>
      </div>
    </div>
  </div>

</div>

<script>
    handler = Gmaps.build('Google');
    handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
      markers = handler.addMarkers([
        {
          "lat": <%= @donation.company.latitude %>,
          "lng": <%= @donation.company.longitude %>,
          "infowindow": "<%= @donation.company.name %>"
        }
      ]);
      handler.bounds.extendWith(markers);
      handler.fitMapToBounds();
});
</script>