<% if $activeapps != nil %>
<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
            ACCOUNT
            <% if @user.anonymous %>
              ********
            <% else %>
              <%= @user.name + " " + @user.lastname %>
            <% end %>
        </h2>
      </div>
      <div class="panel-body">
        <%= link_to users_path :page => session[:page] do %>
          <i class="btn btn-primary btn-lg glyphicon glyphicon-list"></i>
        <% end %>
        <% if user_signed_in? %>
	        <%= link_to new_favourit_path :object_name => "User", :object_id => @user.id, :user_id => current_user.id do %>
            <i class="btn btn-primary btn-lg glyphicon glyphicon-star"></i>
          <% end %>
          <% if current_user.id == @user.id or current_user.superuser %>
  	        <%= link_to edit_user_path(@user) do %>
              <i class="btn btn-primary btn-lg glyphicon glyphicon-wrench"></i>
            <% end %>
  	        <%= link_to @user, method: :delete, data: { confirm: 'Are you sure?' } do %>
              <i class="btn btn-danger btn-lg pull-right glyphicon glyphicon-trash"></i>
            <% end %>
          <% end %>
	        <%= link_to new_webmaster_path :object_name => "User", :object_id => @user.id, :user_id => current_user.id do %>
            <i class="btn btn-warning btn-lg pull-right glyphicon glyphicon-eye-open"></i>
          <% end %>
        <% end %>
      </div>
      <div class="panel-body">
				<% if @user.anonymous or @user.avatar_file_name == nil %>
          <%= image_tag("user_a.png", :size => "200x200", class:"img-rounded" ) %>
        <% else %>
          <%= image_tag @user.avatar(:medium), class:"img-rounded"  %>
          <br>
          <cite><%= @user.created_at.strftime("%d.%m.%Y") %></cite><br>
          <% if !@user.anonymous and @user.phone1 != nil %>
            <i class="glyphicon glyphicon-phone"></i><%= @user.phone1 %><br> 
          <% end %>
          <% if !@user.anonymous and @user.phone2 != nil %>
            <i class="glyphicon glyphicon-phone"></i><%= @user.phone2 %><br> 
          <% end %>
          <i class="glyphicon glyphicon-envelope"></i><%= @user.email %><br>
        <% end %>
        <br>
        <%= form_tag user_path, :method => "get" do %>
          <div class="form-group">
            <%= label_tag "Betreff" %>
            <% if user_signed_in? %>
              <%= text_field_tag :header, "Nachricht von "+ current_user.name + " " + current_user.lastname, class:"form-control" %>
            <% else %>
              <%= text_field_tag :header, "Nachricht von ...", class:"form-control" %>
            <% end %>
          </div>
          <div class="form-group">
            <%= label_tag "Nachricht" %>
            <%= text_area_tag :body, params[:body], rows: 5, class:"form-control" %>
          </div>
          <%= f.hidden_field :@user.id %>
          <div class="form-group">
            <%= submit_tag "Senden", :name => nil , class:"btn btn-primary btn-lg" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <br>

<% if !@user.anonymous %>
<% if $activeapps.include?("Services") %>
<div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
          <% if user_signed_in? %>
            <% if current_user.id == @user.id %>
              <%= link_to new_service_path :user_id => @user.id do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-plus"></i>
              <% end %>
            <% end %>
          <% end %>
            ANGEBOT
        </h2>
      </div>
      <div class="panel-body">
      		<% @user.services.each do |us| %>
    				<a class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-375571" href="#panel-element-service<%= us.id %>"><h3><%= us.name %></h3></a>
    				<div id="panel-element-service<%= us.id %>" class="panel-collapse collapse">
      				<% if us.avatar_file_name == nil %>
                <%= image_tag("service_a.png", :size => "200x200", class:"img-rounded" ) %>
              <% else %>
                <%= image_tag us.avatar(:medium), class:"img-rounded"  %>
              <% end %>
              <p>
  						<%= us.description %>
              </p>
    	        <%= link_to service_path(us) do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-info-sign"></i>
              <% end %>
              <% if user_signed_in? %>
                <% if current_user.id == @user.id %>
        	        <%= link_to edit_service_path(us) do %>
                    <i class="btn btn-primary btn-lg glyphicon glyphicon-wrench"></i>
                  <% end %>
        	        <%= link_to us, method: :delete, data: { confirm: 'Are you sure?' } do %>
                    <i class="btn btn-danger btn-lg pull-right glyphicon glyphicon-trash"></i>
                  <% end %>
                <% end %>
              <% end %>
      			</div>
      		<% end %>
    	</div>
    </div>
  </div>
  <br>
<% end %>
  
<% if $activeapps.include?("Institutionen") %>
<div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
          <% if user_signed_in? %>
            <% if current_user.id == @user.id %>
              <%= link_to new_company_path :user_id => @user.id do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-plus"></i>
              <% end %>
            <% end %>
          <% end %>
            INSTITUTIONEN
        </h2>
      </div>
      <div class="panel-body">
      		<% @user.companies.each do |uc| %>
    				<a class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-375572" href="#panel-element-company<%= uc.id %>"><h3><%= uc.name %></h3></a>
    				<div id="panel-element-company<%= uc.id %>" class="panel-collapse collapse">
      				<% if uc.avatar_file_name == nil %>
                <%= image_tag("company_a.png", :size => "200x200", class:"img-rounded" ) %>
              <% else %>
                <%= image_tag uc.avatar(:medium), class:"img-rounded"  %>
              <% end %>
              <p>
              <b>Branche</b><br>
  						<%= uc.category.name %>
  						</p>
              <p>
  						<%= uc.description %>
  						</p>
  						<br>
    	        <%= link_to uc do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-info-sign"></i>
              <% end %>
      			</div>
      		<% end %>
    	</div>
    </div>
  </div>
  <br>
  <% end %>
  
<% if $activeapps.include?("Kleinanzeigen") %>
  <div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
          <% if user_signed_in? %>
            <% if current_user.id == @user.id %>
              <%= link_to new_request_path(:rtype => "biete", :user_id => current_user.id) do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-plus"> Anbieten</i>
              <% end %>
              <%= link_to new_request_path(:rtype => "suche", :user_id => current_user.id) do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-plus"> Suchen</i>
              <% end %>
            <% end %>
          <% end %>
            KLEINANZEIGEN
        </h2>
      </div>
      <div class="panel-body">
      		<% @user.requests.order(created_at: :desc).each do |ur| %>
    				<a class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-375573" href="#panel-element-anzeige<%= ur.id %>"><h3><%= ur.rtype + " " + ur.name %></h3></a>
    				<div id="panel-element-anzeige<%= ur.id %>" class="panel-collapse collapse">
              <p>
              <b>Anzeigetext vom <%= ur.created_at.strftime("%d.%m.%Y") %></b><br>
  						<%= ur.description %>
  						</p>
  						<% ur.request_details.each do |urd| %>
  						  <p>
                <b><%= urd.name %><br></b>
        				<% if urd.avatar_file_name == nil %>
                  <%= image_tag("request_a.jpg", :size => "200x200", class:"img-rounded" ) %>
                <% else %>
                  <%= image_tag urd.avatar(:medium), class:"img-rounded"  %>
                <% end %>
                <%= urd.description %>
                </p>
  						<% end %>
  						<br>
    	        <%= link_to ur do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-info-sign"></i>
              <% end %>
      			</div>
      		<% end %>
    	</div>
    </div>
  </div>
  <br>
  <% end %>

<% if $activeapps.include?("Mobilien") %>
  <div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
          <% if user_signed_in? %>
            <% if current_user.id == @user.id %>
              <%= link_to new_vehicle_path(:user_id => current_user.id) do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-plus"></i>
              <% end %>
            <% end %>
          <% end %>
            MOBILIEN
        </h2>
      </div>
      <div class="panel-body">
      		<% @user.vehicles.each do |uv| %>
    				<a class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-375574" href="#panel-element-vehicle<%= uv.id %>"><h3><%= uv.name %></h3></a>
    				<div id="panel-element-vehicle<%= uv.id %>" class="panel-collapse collapse">
      				<% if uv.avatar_file_name == nil %>
                <%= image_tag("vehicle_a.png", :size => "200x200", class:"img-rounded" ) %>
              <% else %>
                <%= image_tag uv.avatar(:medium), class:"img-rounded"  %>
              <% end %>
              <p>
  						<%= uv.description %>
  						</p>
  						<br>
    	        <%= link_to uv do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-info-sign"></i>
              <% end %>
      			</div>
      		<% end %>
    	</div>
    </div>
  </div>
  <br>
  <% end %>
  
<% if $activeapps.include?("Veranstaltungen") %>
  <div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
          <% if user_signed_in? %>
            <% if current_user.id == @user.id %>
              <%= link_to new_event_path(:user_id => current_user.id) do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-plus"></i>
              <% end %>
            <% end %>
          <% end %>
            VERANSTALTUNGEN
        </h2>
      </div>
      <div class="panel-body">
      		<% @user.events.each do |ue| %>
    				<a class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-375584" href="#panel-element-event<%= ue.id %>"><h3><%= ue.name %></h3></a>
    				<div id="panel-element-event<%= ue.id %>" class="panel-collapse collapse">
      				<% if ue.avatar_file_name == nil %>
                <%= image_tag("vehicle_a.png", :size => "200x200", class:"img-rounded" ) %>
              <% else %>
                <%= image_tag ue.avatar(:medium), class:"img-rounded"  %>
              <% end %>
              <p>
  						<%= ue.description %>
  						</p>
  						<br>
    	        <%= link_to ue do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-info-sign"></i>
              <% end %>
      			</div>
      		<% end %>
    	</div>
    </div>
  </div>
  <br>
  <% end %>

<% if $activeapps.include?("Sehenswürdigkeiten") %>
  <div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
          <% if user_signed_in? %>
            <% if current_user.id == @user.id %>
              <%= link_to new_hotspot_path(:user_id => current_user.id) do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-plus"></i>
              <% end %>
            <% end %>
          <% end %>
            SEHENSWÜRDIGKEITEN / AUSFLUGSZIELE
        </h2>
      </div>
      <div class="panel-body">
      		<% @user.hotspots.each do |uh| %>
    				<a class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-375584" href="#panel-element-event<%= uh.id %>"><h3><%= uh.name %></h3></a>
    				<div id="panel-element-event<%= uh.id %>" class="panel-collapse collapse">
              <% if uh.hotspot_details.first != nil %>
        				<% if uh.hotspot_details.first.avatar_file_name == nil %>
                  <%= image_tag("target_a.png", :size => "200x200", class:"img-rounded" ) %>
                <% else %>
                  <%= image_tag uh.hotspot_details.first.avatar(:medium), class:"img-rounded"  %>
                <% end %>
              <% end %>
              <p>
  						<%= uh.description %>
  						</p>
  						<br>
    	        <%= link_to uh do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-info-sign"></i>
              <% end %>
      			</div>
      		<% end %>
    	</div>
    </div>
  </div>
  <br>
  <% end %>
  
<% if $activeapps.include?("Ausschreibungen") %>
  <div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
          <% if user_signed_in? %>
            <% if current_user.id == @user.id %>
              <%= link_to new_bid_path(:user_id => current_user.id) do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-plus"></i>
              <% end %>
            <% end %>
          <% end %>
            AUSSCHREIBUNGEN
        </h2>
      </div>
      <div class="panel-body">
      		<% @user.bids.each do |ub| %>
    				<a class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-375575" href="#panel-element-bid<%= ub.id %>"><h3><%= ub.name + " vom " + ub.created_at.strftime("%d.%m.%Y") %></h3></a>
    				<div id="panel-element-bid<%= ub.id %>" class="panel-collapse collapse">
    				  <%= ub.description %>
    				  <% ub.bid_details.each do |ubd| %>
    				    <p>
          				<% if ubd.avatar_file_name == nil %>
                    <%= image_tag("bid_a.png", :size => "200x200", class:"img-rounded" ) %>
                  <% else %>
                    <%= image_tag ubd.avatar(:medium), class:"img-rounded"  %>
                  <% end %>
                  <br>
                  <b><%= ubd.name %></b>
      						<br>
      						<%= ubd.description %>
  						  </p>
  						<% end %>
  						<br>
    	        <%= link_to ub do %>
                <i class="btn btn-primary btn-lg glyphicon glyphicon-info-sign"></i>
              <% end %>
      			</div>
      		<% end %>
    	</div>
    </div>
  </div>
  <br>
  <% end %>

  <% if $activeapps.include?("Spenden") %>
  <div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
            SPENDEN
        </h2>
      </div>
      <div class="panel-body">
  		    <% if @user.donation_stats.count > 0 %>
      			<a class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-spenden" href="#panel-element-spenden"><h3>Spenden (<%= sprintf("%05.2f CHF", @user.donation_stats.sum(:amount)) + " / " + @user.donation_stats.count.to_s %>)</h3></a>
      			<div id="panel-element-spenden" class="panel-collapse collapse">
						<table class="table table striped">
						  <thead>
						    <tr>
    						  <th colspan="3">
    						    Spendeninitiative
    						  </th>
    						  <th>
    						    Betrag
    						  </th>
    						  <th>
    						    Datum
    						  </th>
                </tr>
              </thead>
              <tbody>
              <% @user.donation_stats.each do |uds| %>
                <tr>
                  <td>
          	        <%= link_to uds.donation do %>
                      <i class="btn btn-primary btn-lg glyphicon glyphicon-info-sign"></i>
                    <% end %>
                  </td>
                  <td>
            				<% if uds.donation.company.avatar_file_name == nil %>
                      <%= image_tag("company_a.png", :size => "50x50", class:"img-rounded" ) %>
                    <% else %>
                      <%= image_tag uds.donation.company.avatar(:small), class:"img-rounded"  %>
                    <% end %>
                    <%= uds.donation.company.name %>
                  </td>
                  <td>
                    <%= uds.donation.name %>
                    <br>
                    <% uds.donation.donation_details.each do |udd| %>
              				<% if udd.avatar_file_name == nil %>
                        <%= image_tag("donation_a.jpg", :size => "50x50", class:"img-rounded" ) %>
                      <% else %>
                        <%= image_tag udd.avatar(:small), class:"img-rounded"  %>
                      <% end %>
                    <% end %>
                  </td>
                  <td>
                    <%= sprintf("%05.2f CHF", uds.amount) %>
                  </td>
                  <td>
                    <%= uds.created_at.strftime("%d.%m.%Y") %>
                  </td>
                </tr>
              <% end %>
              </tbody>
						</table>
				  </div>
				<% end %>
    	</div>
    </div>
  </div>
  <br>
  <% end %>

<% if $activeapps.include?("Bewertungen") %>
  <div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
            RATINGS
        </h2>
      </div>
      <div class="panel-body">
        <% if @user.ratings.count > 0 %>
    			<a class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-rating" href="#panel-element-rating"><h3>Bewertungen (<%= @user.ratings.count.to_s %>)</h3></a>
    			<div id="panel-element-rating" class="panel-collapse collapse">
					<table class="table table striped">
					  <thead>
					    <tr>
					      <th></th>
  						  <th>
  						    Bewertung
  						  </th>
  						  <th colspan="3">
  						    Service
  						  </th>
  						  <th>
  						    Kommentar
  						  </th>
  						  <th>
  						    Datum
  						  </th>
              </tr>
            </thead>
            <tbody>
            <% @user.ratings.each do |ur| %>
              <tr>
                <td>
        	        <%= link_to ur.service do %>
                    <i class="btn btn-primary btn-lg glyphicon glyphicon-info-sign"></i>
                  <% end %>
                </td>
                <td>
                  <% ur.user_rating.times do %>
                    <% image_tag("rating_star.jpg", :size => "50x50" , class:"img-rounded") %>
                    <i class="glyphicon glyphicon-star"></i>
                  <% end %>
                </td>
                <td>
                  <% if ur.service.avatar == nil %>
                    <%= image_tag("service_a.png", :size => "50x50" , class:"img-rounded") %>
                  <% else %>
                    <%= image_tag ur.service.avatar(:small), class:"img-rounded" %>
                  <% end %>
                </td>
                <td>
                  <%= ur.service.name %>
                </td>
                <td>
                  <% if ur.service.user_id != nil %>
                    <%= ur.service.user.name + " " + ur.service.user.lastname %>
                  <% end %>
                  <% if ur.service.company_id != nil %>
                    <%= ur.service.company.name %>
                  <% end %>
                </td>
                <td>
                  <%= ur.user_comment %>
                </td>
                <td>
                  <%= ur.created_at.strftime("%d.%m.%Y") %>
                </td>
              </tr>
            <% end %>
            </tbody>
					</table>
					</div>
				<% end %>
    	</div>
    </div>
  </div>
  <br>
  <% end %>

<% if $activeapps.include?("Favoriten") %>
	<div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h1>
        <%= link_to new_favourit_path do %>
          <i class="btn btn-primary btn-lg glyphicon glyphicon-plus"></i>
        <% end %>
        Favoriten
        <span class="badge"><%= @favanz %></span>
        </h1>
      </div>
      <div class="panel-body">
  			<a class="panel-title collapsed" data-toggle="collapse" data-parent="#panel-favourit" href="#panel-element-favourit"><h3>Favoriten (<%= @user.favourits.count.to_s %>)</h3></a>
  			<div id="panel-element-favourit" class="panel-collapse collapse">
      		<table class="table table-striped">
            <thead>
              <tr>
                <th></th>
                <th>Status</th>
                <th>Favorit</th>
                <th>eMail</th>
                <th>Ticker</th>
              </tr>
            </thead>
            <tbody>
                <% @user.favourits.each do |f| %>
                  <tr>
                    <td>
                      <% if user_signed_in? %>
                        <% if @user.id == current_user.id %>
                	        <%= link_to edit_favourit_path(f) do %>
                            <i class="btn btn-primary btn-lg glyphicon glyphicon-wrench"></i>
                          <% end %>
                	        <%= link_to f, method: :delete, data: { confirm: 'Are you sure?' } do %>
                            <i class="btn btn-danger btn-lg glyphicon glyphicon-trash"></i>
                          <% end %>
                        <% end %>
                      <% end %>
                    </td>
        				    <td>
                      <% if f.active %>
                        <% image_tag("icon_active.jpg", :size => "50x50" , class:"img-rounded") %>
                         <i class="glyphicon glyphicon-ok-sign"></i>
                      <% else %>
                        <% image_tag("icon_inactive.jpg",:size => "50x50", class:"img-rounded") %>
                         <i class="glyphicon lg glyphicon-remove-sign"></i>
                      <% end %>
                    </td>
                    <td>
                      <div class="anzeigetext">
                        <% @item = Object.const_get(f.object_name).find(f.object_id) %>
                        <% if @item != nil %>
                          <%= f.object_name + ": " + @item.name %>
                        <% else %>
                          <%= f.object_name %><br>
                          <%= f.object_id %>
                        <% end %>
                      </div>
                    </td>
                    <td>
                      <% if f.email %>
                        <% image_tag("icon_active.jpg", :size => "50x50" , class:"img-rounded") %>
                         <i class="glyphicon glyphicon-ok-sign"></i>
                      <% else %>
                        <% image_tag("icon_inactive.jpg",:size => "50x50", class:"img-rounded") %>
                         <i class="glyphicon lg glyphicon-remove-sign"></i>
                      <% end %>
                    </td>
                    <td>
                      <% if f.ticker %>
                        <% image_tag("icon_active.jpg", :size => "50x50" , class:"img-rounded") %>
                         <i class="glyphicon glyphicon-ok-sign"></i>
                      <% else %>
                        <% image_tag("icon_inactive.jpg",:size => "50x50", class:"img-rounded") %>
                         <i class="glyphicon lg glyphicon-remove-sign"></i>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
<br>
<% end %>
  
  <div class="row">
    <div class="col-md-12">
      <div class="panel-heading header">
        <h2>
            ORTSANGABE
        </h2>
      </div>
    </div>
    <div class="col-md-12">
      <div class="panel-body">
        <div id="map">
          <div id="map-canvas"></div>
        </div>
      </div>
    </div>
  </div>
  <br>
  <% end %>
</div>
<% end %>

<script>
    handler = Gmaps.build('Google');
    handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
      markers = handler.addMarkers([
        {
          "lat": <%= @user.latitude %>,
          "lng": <%= @user.longitude %>,
          "infowindow": "<%= @user.name + " " + @user.lastname %>"
        }
      ]);
      handler.bounds.extendWith(markers);
      handler.fitMapToBounds();
});
</script>